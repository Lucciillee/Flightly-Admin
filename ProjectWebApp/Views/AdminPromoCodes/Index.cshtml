@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Promo Codes";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-promo.css" asp-append-version="true" />
}

<div class="content">

    <div class="card">
        <div class="card-h" style="display:flex; justify-content:space-between; align-items:center;">
            <span>Promo Codes</span>
            <div class="actions">
                <a href="/AdminPromoCodes/Create" class="btn primary">Add Promo</a>
                <a href="/AdminPromoCodes" class="btn outline">Refresh</a>
            </div>
        </div>

        <div class="card-b">

            <!-- Search -->
            <div class="search-bar left">
                <input type="text" id="promoSearch" placeholder="Search code or type..." />
                <button class="btn primary" onclick="filterPromo()">Filter</button>
            </div>

            <!-- Table -->
            <table class="table" id="promoTable">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Value</th>
                        <th>Valid</th>
                        <th>Status</th>
                        <th class="right">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var promo in Model)
                    {
                        <tr>
                            <td>@promo.Code</td>

                            <td>
                                @(promo.Value % 1 == 0
                                    ? $"{promo.Value:0}%"
                                    : $"${promo.Value}")
                            </td>

                            <td>@promo.StartDate.ToString("yyyy-MM-dd") → @promo.EndDate.ToString("yyyy-MM-dd")</td>

                            <!-- STATUS BADGE -->
                            <!-- STATUS BADGE -->
                            <td>
                                @if (promo.StatusId == 1)
                                {
                                    <span class="badge ok">Active</span>
                                }
                                else if (promo.StatusId == 2)
                                {
                                    <span class="badge">Expired</span>
                                }
                                else if (promo.StatusId == 3)
                                {
                                    <span class="badge upcoming">Upcoming</span>
                                }
                                else if (promo.StatusId == 4)
                                {
                                    <span class="badge disabled">Disabled</span>
                                }
                            </td>

                            
                            <!-- ACTION BUTTONS -->
                            <td class="right">

                                @* EXPIRED — ONLY VIEW + DELETE *@
                                @if (promo.StatusId == 2)
                                {
                                    <a href="/AdminPromoCodes/Details/@promo.PromoId" class="btn small">View</a>
                                    <span class="btn small disabled">Edit</span>
                                    <button class="btn small danger" onclick="deletePromo(@promo.PromoId)">Delete</button>
                                }
                                else
                                {
                                    @* EDIT Button *@
                                    <a href="/AdminPromoCodes/Edit/@promo.PromoId" class="btn small">Edit</a>

                                    @* ENABLE / DISABLE Logic *@
                                    @if (promo.StatusId == 1)  @* Active *@
                                    {
                                        <a href="/AdminPromoCodes/Disable/@promo.PromoId" class="btn small">Disable</a>
                                    }
                                    else if (promo.StatusId == 4) @* Disabled *@
                                    {
                                        <a href="/AdminPromoCodes/Enable/@promo.PromoId" class="btn small">Enable</a>
                                    }
                                    else if (promo.StatusId == 3) // Upcoming
                                    {
                                        <span class="btn small disabled">Upcoming</span>
                                    }

                                    @* DELETE BUTTON *@
                                    <button class="btn small danger" onclick="deletePromo(@promo.PromoId)">Delete</button>
                                }
                            </td>


                        </tr>
                    }
                </tbody>

            </table>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        const search = document.getElementById("promoSearch");
        const rows = document.querySelectorAll("#promoTable tbody tr");

        function filterPromo() {
            const s = search.value.toLowerCase();
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(s) ? "" : "none";
            });
        }

        search.addEventListener("keyup", filterPromo);

        // -------------------------------
        // DELETE PROMO CONFIRMATION
        // -------------------------------
        function deletePromo(id) {
            if (confirm("Are you sure you want to delete this promo code?")) {
                window.location.href = '/AdminPromoCodes/Delete/' + id;
            }
        }
    </script>
}

