@model IEnumerable<ProjectWebApp.Model.UserProfile>

@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Manage Users";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-users.css" asp-append-version="true" />
}

<div class="content">

    <!-- Users Table -->
    <div class="card">
        <div class="card-h">Users</div>
        <div class="card-b">

            <!-- Search Bar -->
            <div class="search-bar left">
                <input type="text" id="userSearch" placeholder="Search by name or email..." />
                <button class="btn primary">Search</button>
            </div>

            <table class="table" id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Joined</th>
                        <th class="right">Action</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td>@user.FirstName @user.LastName</td>
                            <td>@user.Email</td>
                            <td>@user.CreatedAt.ToString("yyyy-MM-dd")</td>

                            <td class="right">
                                @if (user.IsDeleted)
                                {
                                    <!-- User is blocked -->
                                    <a href="/AdminUsers/Unblock/@user.UserId" class="btn small">Unblock</a>
                                }
                                else
                                {
                                    <!-- User is active -->
                                    <a href="/AdminUsers/Block/@user.UserId" class="btn small">Block</a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>
    </div>

    <!-- User Growth Chart -->
    <div class="card chart">
        <div class="card-h">User Growth</div>
        <div class="card-b">
            <div class="chart-wrapper">
                <canvas id="usersChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Convert server-side data to JS arrays
        const monthLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.MonthLabels));
        const monthCounts = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.MonthCounts));

        const ctx = document.getElementById('usersChart');

        if (ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,     // Dynamic month names
                    datasets: [{
                        label: 'New Users',
                        data: monthCounts,    // Dynamic user count per month
                        fill: true,
                        borderColor: '#0d8bf2',
                        backgroundColor: 'rgba(13,139,242,0.08)',
                        tension: 0.4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#6b7280' },
                            grid: { color: '#f1f5f9' }
                        },
                        x: {
                            ticks: { color: '#6b7280' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Search filter
        document.getElementById('userSearch').addEventListener('keyup', function () {
            const s = this.value.toLowerCase();
            document.querySelectorAll('#usersTable tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(s) ? "" : "none";
            });
        });
    </script>
}
